# 拡張機能改善案

## 現在の問題点

- メモリ使用率が多すぎる！

* 拡張機能の常時稼働はやめて、offscreen + service worker（MV3）でイベント駆動にする
* Chrome のみ対応とする

- 以下の場合のみ常時稼働をする。
- 1,youtubeが再生されている時
- 2,ショートカットキーが押された時
- 3,popup開かれて、ボタンが押された時

youtube stateとかはyoutubeが動いている時に動くように直す
urlリストは先ほどの1,2,3が動いている時に今まで通りに更新するようにする

---

## 前提 / スコープ

- 対象ブラウザ: Chrome のみ（Manifest V3 / offscreen API 前提）
- 目的: 「メモリ削減」と「壊さない段階移行（常に動く状態を維持）」
- 方針: デフォルト挙動は維持しつつ、Feature Flag で段階的に移行（ロールバック可能）

## ゴール（受入基準）

### 機能面（壊さない）

- 既存のショートカット操作、Popup操作、動画終了時の次曲遷移、URLリスト更新が今まで通り動く
- 既存のクリティカルテストが通る（例: tests/critical 配下）

### パフォーマンス面（メモリ/常時稼働）

- 常時稼働は「1) YouTube再生中」「2) ショートカット押下」「3) Popup操作中」に限定する
- offscreen を「必要な時だけ」作成し、不要になれば破棄できる（作成失敗時も既存挙動で継続）

※数値目標（あとで埋める）

- 目標メモリ上限（拡張の概算）: ___MB 以下
- offscreen 作成成功率: ___% 以上
- broker/通信 ack の p95: ___ms 以下

## 現状把握（既にある構成）

- Service Worker: youtube-auto-play/src/background/sw.ts
- Offscreen: youtube-auto-play/src/offscreen/offscreen.ts
- Content script（YouTube）: youtube-auto-play/src/content/content.ts
- Popup: youtube-auto-play/src/popup/popup.tsx
- サーバ側拡張イベント: src/server/socket/handlers/extensionEventHandlers.ts

※現状でも MV3 + offscreen は既に存在するが、SW が onStartup/onInstalled/alarms などで offscreen を自動確保しようとしているため「完全なイベント駆動（必要時のみ）」には未達。

## 互換性境界（壊しやすい契約）

壊さないために、以下は「追加はOK / 変更・削除は段階的に」ルールで扱う。

### 1) 拡張内メッセージ（type / payload）

- content → SW: progress_update / progress_update_batch / video_ended / youtube_video_state など
- popup → SW: delete_url / move_next_video / move_prev_video / wait_for_end など
- SW ↔ offscreen: audio_connect / audio_disconnect / OFFSCREEN_READY / offscreen_lifecycle など

### 2) サーバ socket イベント名 / payload

- url_list / next_video_navigate / new_url / progress_update / video_ended など

### 3) storage（キー名 / 型）

- url_list の保存形式
- 診断/ログ（リングバッファ）系キーの上限とサンプリング率

## 安全な進め方（Feature Flag / ロールバック）

- Feature Flag は「デフォルトOFF」で導入し、OFF時は挙動が一切変わらないことを保証する
- まず Shadow（並走・観測のみ）→ 表示系から Active → 最後に制御面を Active
- 失敗時は必ず旧経路にフォールバックし、フラグOFFで即ロールバックできるようにする

## PR 分割（常に動く状態を維持）

### PR1（挙動変更なし）: 計画と契約の明文化

- 目的: 変更点が壊しやすい境界（message/event/storage）を一覧化し、受入基準とロールバック方針を固定する
- 受入条件:
  - 既存テストが全て通る
  - この計画書に「契約」「段階移行」「数値目標」「ロールバック」が書かれている

### PR2（デフォルトOFF）: Feature Flag と観測追加（挙動不変）

- 目的: 移行の土台だけ入れる（ログ/診断/メトリクス）
- 受入条件:
  - フラグOFFで挙動が変わらない
  - ログ/診断の保存は上限付きで肥大化しない

### PR3（Shadow）: broker/offscreen 経路の並走（制御は旧経路）

- 目的: 新経路の成功率/遅延/欠落を観測し、差分を把握
- 受入条件:
  - Shadow ONでもユーザー操作・自動遷移は現行と一致
  - タイムアウト時に必ず旧経路へフォールバック

### PR4（Active・表示系から）: url_list / 状態表示の新経路化

- 受入条件:
  - Popup表示とURLリスト更新が崩れない
  - フラグOFFで即座に元に戻る

### PR5（Active・制御面は最後）: next_video_navigate / move_* / delete_url / wait_for_end

- 受入条件:
  - tests/critical/extensionEventHandlers.* が通る
  - タイムアウト/失敗で旧経路フォールバック

### PR6（最終）: 常時稼働の削減を確定（offscreen自動確保停止 / contentタイマー抑制）

- 受入条件:
  - 「再生/操作時のみ」稼働できる
  - 既存テスト・手動動作確認がOK

## 動作確認（最小）

- tests/critical の実行
- 手動: YouTube 再生開始 → 状態更新、動画終了 → 次曲遷移、Popupから削除/次へ、ショートカットでの操作

## 未確定（あとで決める）

- Chrome 最低バージョン（offscreen API 前提を明記）
- 数値目標（メモリ上限、p95遅延、成功率）
- 観測指標（何をログ/メトリクスにするか）
